{% extends 'partials/base.html' %} {% load l10n humanize %}
{% load static %}
{% block content %}
<script src="https://www.paypal.com/sdk/js?client-id=test&currency={{ selected_currency }}"></script>
<script src="https://checkout.flutterwave.com/v3.js"></script>
<style>
    /* Payment Info Container */
    .payment-info {
        border: 1px solid #dcdcdc;
        border-radius: 8px;
        padding: 20px;
        max-width: 600px;
        margin: 20px auto;
    }
    .payment-icon {
        width: 50px; /* Adjust the size of the icon */
        height: 24px;
        margin-right: 10px; /* Space between the icon and the text */
        vertical-align: middle; /* Align icon with the text */
    }

    .custom-radio .form-check-label {
        display: flex;
        align-items: center; /* Ensure text and icon are aligned */
        gap: 10px;
    }

    /* Custom Radio Buttons */
    .custom-radio-group {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .custom-radio {
        display: flex;
        align-items: center;
        padding: 10px 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        transition: border-color 0.3s ease;
        cursor: pointer;
    }

    .custom-radio:hover {
        border-color: #ffc400;
    }

    .custom-radio input[type="radio"] {
        display: none;
    }

    .custom-radio .form-check-label {
        position: relative;
        padding-left: 30px;
        font-size: 16px;
    }

    .custom-radio .form-check-label:before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 16px;
        width: 16px;
        border-radius: 50%;
        border: 2px solid #ffc400;
        background-color: transparent;
    }

    .custom-radio input[type="radio"]:checked + .form-check-label:before {
        background-color: #ffc400;
    }

    /* Submit Button */
    .btn-submit {
        padding: 10px 20px;
        font-size: 16px;
        transition: background-color 0.3s ease;
    }
</style>

<!-- Begin E-MariStore Breadcrumb Area -->
<div class="breadcrumb-area">
    <div class="container">
        <div class="breadcrumb-content">
            <h2>Other</h2>
            <ul>
                <li><a href="{% url 'Home' %}">Home</a></li>
                <li class="active">Payment</li>
            </ul>
        </div>
    </div>
</div>

<div class="container my-5" style="background-color: #f8f9fa; padding: 2rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
    

    <h5>Review details and select payment provider</h5>
    <hr>
    <div class="row my-4">
        <!-- Order Information Section -->
        <div class="col-md-6 col-lg-6">
            <div class="card shadow-sm rounded mb-4 p-4">
                <h5 class="card-title mb-4"><strong>Order Details</strong></h5>
                <table class="table table-borderless table-striped">
                    <tbody>
                        <tr>
                            <th scope="row">Order ID</th>
                            <td>{{ order.oid }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Full Name</th>
                            <td>{{ order.full_name }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Email</th>
                            <td>{{ order.email|truncatechars:30 }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Phone Number</th>
                            <td>{{ order.phone_number }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Billing Address</th>
                            <td>{{ order.address }}</td>
                        </tr>
                        <tr>
                            <th scope="row">City</th>
                            <td>{{ order.city }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Country</th>
                            <td>{{ order.country }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    
        <!-- Order Summary Section with Enhanced Width and Spacing -->
        <div class="col-md-6 col-lg-6">
            <div class="card shadow-sm rounded mb-4 p-4">
                <h5 class="card-title mb-4"><strong>Order Summary</strong></h5>
                <!-- Order Items Table -->
                <div class="table-responsive">
                    <table class="table table-borderless table-hover align-middle">
                        <thead class="border-bottom">
                            <tr>
                                <th class="text-center">Product</th>
                                <th class="text-center">Title</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-center">Unit Price</th>
                                <th class="text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for o in order_items %}
                            <tr>
                                <td class="text-center">
                                    <img src="{{ o.product.image.url }}" alt="Product Image" class="rounded img-fluid" style="max-width: 50px;">
                                </td>
                                <td class="text-center">
                                    <strong>{{ o.product.title|truncatechars:10 }}</strong>
                                </td>
                                <td class="text-center">
                                    <strong>X {{ o.qty }}</strong>
                                </td>
                                <td class="text-center text-muted">
                                    {{ o.price|intcomma }}&nbsp;{{ selected_currency }}
                                </td>
                                <td class="text-center">
                                    <strong>{{ o.total|intcomma }}&nbsp;{{ selected_currency }}</strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
    
                <!-- Order Summary Breakdown -->
                <div class="border-top pt-3 mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal</span>
                        <span><strong>{{ converted_order_total|intcomma }} &nbsp;{{ selected_currency }}</strong></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping Fee</span>
                        <span><strong>{{ shipping_fee|intcomma }}&nbsp;{{ selected_currency }}</strong></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Discount</span>
                        <span><strong>- {{ converted_saved_amount|intcomma }}&nbsp;{{ selected_currency }}</strong></span>
                    </div>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total</span>
                        <span><strong>{{ converted_order_total|intcomma }}&nbsp;{{ selected_currency }}</strong></span>
                    </div>
                </div>
            </div>
    
            <!-- Payment Options Section -->
            <div class="card shadow-sm rounded p-4">
                <h5 class="card-title mb-4 pay-title"><strong>Payment Options</strong></h5>
                <span class="card-title mb-4 info" style="display: none;"><strong>Important Info:</strong><span class="text-center text-danger"> Before Proceeding to PayPal Make Sure Price Is converted In One of these Currency (USD, GBP and EUR)</span></span>
                <form id="payment-form" action="{% url 'order_confirmation' order.oid %}" method="POST" class="p-3 shadow-lg rounded border">
                    {% csrf_token %}
                    <!-- Payment Options -->
                    <div class="custom-radio-group">
                        <!-- PayPal Option with Image -->
                        <div class="custom-radio">
                            <input class="form-check-input" type="radio" id="paypal" name="payment_method" value="paypal">
                            <label class="form-check-label" for="paypal">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal Logo" class="payment-icon">
                                <strong>PayPal</strong>
                            </label>
                        </div>
                
                        <!-- Cash On Delivery Option with Image -->
                        <div class="custom-radio mt-2">
                            <input class="form-check-input" type="radio" id="cod" name="payment_method" value="cod">
                            <label class="form-check-label" for="cod">
                                <img src="https://i.etsystatic.com/22467704/r/il/e222bc/2659652120/il_570xN.2659652120_7whv.jpg" alt="Cash on Delivery Logo" class="payment-icon">
                                <strong>Cash On Delivery</strong>
                            </label>
                        </div>
                    </div>
                
                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-danger btn-submit w-100 mt-4 rounded-pill shadow">Proceed to Payment</button>
                </form>
                

                <div id="paypal-button-container" style="display: none;">
                </div>
            </div>
        </div>
    </div>
    
</div>

<script>
    $(document).ready(function(){
        $('input[name="payment_method"]').change(function() {
            var selectedMethod = $('input[name="payment_method"]:checked').val();
            var proceedButton = $('form#payment-form button[type="submit"]');
            
            if(selectedMethod === 'cod') {
                proceedButton.text('Confirm Your Order');
            } else {
                proceedButton.text('Pay With PayPal');
            }
        });

        $('form#payment-form').submit(function(event){
            // Prevent default form submission
            event.preventDefault(); 

            // Get the selected payment method
            var selectedMethod = $('input[name="payment_method"]:checked').val();

            // Check if a payment method is selected
            if (!selectedMethod) {
                alert("No payment method selected. Please choose a payment option.");
                return; // Stop the form from submitting
            }

            // Process PayPal payment
            if(selectedMethod === 'paypal') {
                $('#payment-form').hide();
                $('.pay-title').hide();
                $('.info').show();
                $('#paypal-button-container').show();
                
                if (typeof paypal !== 'undefined' && paypal.Buttons) {
                    paypal.Buttons({
                        createOrder: function(data, actions) {
                            return actions.order.create({
                                purchase_units: [{
                                    amount: {
                                        currency_code: '{{ selected_currency }}',  // Pass the selected currency code
                                        value: '{{ converted_order_total }}'  // Pass the converted amount
                                    }
                                }]
                            });
                        },
                        onApprove: function(data, actions) {
                            return actions.order.capture().then(function(details) {
                                if (details.status === "COMPLETED") {
                                    window.location.href = '/payment_completed_view/{{order.oid}}/?status=' + details.status + '&payment_method=' + selectedMethod;
                                }
                            });
                        },
                        onError: function(err) {
                            window.location.href = '/payment_failed_view/{{order.oid}}/';
                        }
                    }).render('#paypal-button-container');
                } else {
                    console.error('PayPal SDK failed to load.');
                }
            } else if(selectedMethod === 'cod') {
                // Handle Cash on Delivery
                window.location.href = '{% url "order_confirmation" order.oid %}?payment_method=cod';
            } else {
                // If selected method is neither PayPal nor COD, submit the form normally
                this.submit();
            }
        });
    });
</script>


{% endblock %}
